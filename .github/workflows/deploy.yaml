name: Deploy to Production

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | \
          docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}

      - name: Build and push image
        working-directory: ./prod/backend
        run: |
          docker build -t ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:${{ github.sha }} .
          docker tag ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:${{ github.sha }} \
                     ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:latest
          docker push ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:${{ github.sha }}
          docker push ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:latest

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name ${{ secrets.EKS_CLUSTER_NAME }} --region ${{ secrets.AWS_REGION }}

      - name: Replace placeholders in Kubernetes manifests
        working-directory: ./prod/k8s
        run: |
          # Replace AWS_ACCOUNT_ID
          find . -type f -name "*.yaml" -exec sed -i "s|AWS_ACCOUNT_ID|${{ secrets.AWS_ACCOUNT_ID }}|g" {} +
          
          # Replace ECR_REGISTRY
          find . -type f -name "*.yaml" -exec sed -i "s|ECR_REGISTRY|${{ secrets.ECR_REGISTRY }}|g" {} +
          
          # Replace ECR_REPOSITORY
          find . -type f -name "*.yaml" -exec sed -i "s|ECR_REPOSITORY|${{ secrets.ECR_REPOSITORY }}|g" {} +

      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f prod/k8s/

      - name: Update deployment with commit SHA
        run: |
          kubectl set image deployment/webapp-backend \
            fastapi=${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY }}:${{ github.sha }} \
            -n web-app

      - name: Sync frontend to S3
        run: |
          aws s3 sync ./prod/frontend s3://${{ secrets.S3_BUCKET_NAME }} --delete
          aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/*"