name: Deploy to Production

on:
  push:
    branches:
      - main

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to ECR
        run: |
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | \
          docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}

      - name: Build and push backend image
        working-directory: ./prod/backend
        run: |
          docker build -t ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY_BACKEND }}:${{ github.sha }} .
          docker tag ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY_BACKEND }}:${{ github.sha }} \
                     ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY_BACKEND }}:latest
          docker push ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY_BACKEND }}:${{ github.sha }}
          docker push ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY_BACKEND }}:latest

      - name: Build and push frontend image
        working-directory: ./prod/frontend
        run: |
          docker build -t ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY_FRONTEND }}:${{ github.sha }} .
          docker tag ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY_FRONTEND }}:${{ github.sha }} \
                     ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY_FRONTEND }}:latest
          docker push ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY_FRONTEND }}:${{ github.sha }}
          docker push ${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY_FRONTEND }}:latest

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name ${{ secrets.EKS_CLUSTER_NAME }} --region ${{ secrets.AWS_REGION }}

      - name: Replace placeholders in Kubernetes manifests
        working-directory: ./prod/k8s
        run: |
          # Replace AWS_ACCOUNT_ID in all files
          find . -type f -name "*.yaml" -exec sed -i "s|AWS_ACCOUNT_ID|${{ secrets.AWS_ACCOUNT_ID }}|g" {} +
          
          # Replace ECR_REGISTRY in all files
          find . -type f -name "*.yaml" -exec sed -i "s|ECR_REGISTRY|${{ secrets.ECR_REGISTRY }}|g" {} +
          
          # Replace ECR_REPOSITORY_BACKEND in backend file
          sed -i "s|ECR_REPOSITORY_BACKEND|${{ secrets.ECR_REPOSITORY_BACKEND }}|g" fastapi.yaml

          # Replace ECR_REPOSITORY_FRONTEND in frontend file
          sed -i "s|ECR_REPOSITORY_FRONTEND|${{ secrets.ECR_REPOSITORY_FRONTEND }}|g" frontend.yaml

      - name: Wait for External Secrets CRDs
        run: |
          kubectl wait --for=condition=established --timeout=60s crd/clustersecretstores.external-secrets.io
          kubectl wait --for=condition=established --timeout=60s crd/externalsecrets.external-secrets.io

      - name: Verify CRDs exist
        run: |
          kubectl get crd clustersecretstores.external-secrets.io
          kubectl get crd externalsecrets.external-secrets.io

      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f prod/k8s/ --validate=false

      - name: Update backend deployment with commit SHA
        run: |
          kubectl set image deployment/webapp-backend \
            fastapi=${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY_BACKEND }}:${{ github.sha }} \
            -n web-app

      - name: Update frontend deployment with commit SHA
        run: |
          kubectl set image deployment/webapp-frontend \
            frontend=${{ secrets.ECR_REGISTRY }}/${{ secrets.ECR_REPOSITORY_FRONTEND }}:${{ github.sha }} \
            -n web-app

      - name: Verify deployments
        run: |
          kubectl rollout status deployment/webapp-backend -n web-app --timeout=120s
          kubectl rollout status deployment/webapp-frontend -n web-app --timeout=120s